# JDK Compilation Runner (Step 3)

This directory contains the script that drives Step 3 of the pipeline: compiling every bugs-dot-jar branch under JDK 6 inside Docker and recording which builds succeed.

## Script

**`run_jdk6_and_7.py`**
For each branch listed in `outputs/no_equi_patch.txt`:

1. Clones the corresponding bugs-dot-jar project branch from GitHub.
2. Dynamically generates a `Dockerfile` that layers the branch source on top of the `maven3.2.5-jdk6` base image (see `setup/maven3.2.5-jdk6/`).
3. Builds the Docker image and runs `mvn clean install -DskipTests`.
4. Records the outcome (`success`, `failure`, `build_failed`, `clone_failed`, `run_failed`) together with the full console log in MongoDB.
5. Cleans up the Docker container, image, generated `Dockerfile`, and cloned repository directory after each run.

Results are stored in the MongoDB collection `build_results.results`.

## Prerequisites

- **Docker** — must be running and accessible via the Docker socket.
- **MongoDB** — a local instance at `mongodb://localhost:27017/` with user `admin` and password `secret`. Adjust the connection string at the top of the script if your setup differs.
- **`maven3.2.5-jdk6` Docker image** — built from the submodule at `setup/maven3.2.5-jdk6/`:
  ```bash
  git submodule update --init setup/maven3.2.5-jdk6
  cd setup/maven3.2.5-jdk6
  docker build -t maven3.2.5-jdk6 .
  ```
- **GitHub PAT** - To clone the GitHub `bugs-dot-jar` repositories
- **Python dependencies** — install via:
  ```bash
  pip install -r jdk/requirements.txt
  ```

## Input

| File | Description |
|------|-------------|
| `outputs/no_equi_patch.txt` | List of branch names to process (one per line), generated by `pipeline/check_test_equi.py` |

## Output

All results are written to MongoDB:

| Field | Description |
|-------|-------------|
| `repository` | Branch name (e.g., `bugs-dot-jar_OAK-47_b62f1c26`) |
| `jdk` | JDK variant used (`jdk6`) |
| `result` | Outcome: `success`, `failure`, `clone_failed`, `build_failed`, or `run_failed` |
| `timestamp` | ISO timestamp of the run |
| `output` | Full console log from the Maven/Docker build |

## Running

```bash
# From the repository root
python jdk/run_jdk6_and_7.py
```

The script skips any branch whose directory already exists locally, so it is safe to re-run after interruptions.
